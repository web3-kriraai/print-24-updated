# COMPLAINT MANAGEMENT SYSTEM - DEPLOYMENT GUIDE

## Prerequisites
- Node.js 16+ installed
- MongoDB database
- Email service configured (for notifications)
- Cloudinary account (for image uploads - optional)

---

## Backend Deployment Steps

### 1. Copy All Backend Files
Copy these directories/files to your production server:

```
server/src/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ User.js [MODIFIED - lines 128-145]
â”‚   â””â”€â”€ ComplaintSchema.js [NEW]
â”‚
â”œâ”€â”€ utils/complaint/ [NEW DIRECTORY]
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ staffTimeLimits.js
â”‚   â””â”€â”€ complaintHelpers.js
â”‚
â”œâ”€â”€ middlewares/
â”‚   â””â”€â”€ complaintValidation.js [NEW]
â”‚
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ complaintController.js [NEW]
â”‚
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ complaintRoutes.js [NEW]
â”‚   â”œâ”€â”€ webhooks.js [NEW]
â”‚   â””â”€â”€ index.js [MODIFIED - lines 450-463]
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ complaintNotificationService.js [NEW]
â”‚
â””â”€â”€ templates/
    â””â”€â”€ complaintEmails.js [NEW]
```

### 2. Environment Variables
Add to your `.env` file:

```env
# Complaint System
FRONTEND_URL=https://your-domain.com
# Email service credentials already configured
```

### 3. Database Indexes
Run these MongoDB commands after deployment:

```javascript
use your_database_name;

// Create indexes for performance
db.complaints.createIndex({ orderNumber: 1 });
db.complaints.createIndex({ status: 1, createdAt: -1 });
db.complaints.createIndex({ raisedBy: 1, createdAt: -1 });
db.complaints.createIndex({ assignedTo: 1, status: 1 });
db.complaints.createIndex({ deliveryDate: 1, createdAt: 1 });
db.complaints.createIndex({ registerSource: 1 });
db.complaints.createIndex({ reopenSource: 1 });
```

### 4. Restart Server
```bash
npm install  # If any new dependencies
npm start
```

---

## Frontend Deployment Steps

### 1. Copy Frontend Files
```
client/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ RegisterComplaint.tsx [NEW]
â”‚   â”œâ”€â”€ ComplaintDetails.tsx [NEW]
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ AdminComplaintManagement.tsx [NEW]
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ ComplaintButton.tsx [NEW]
â”‚
â””â”€â”€ routes.tsx [MODIFIED - lines 72-73]
```

### 2. Update OrderDetails.tsx (MANUAL STEP)
Add the ComplaintButton component to your OrderDetails page:

```tsx
// 1. Import at top
import { ComplaintButton } from '../components/ComplaintButton';

// 2. Add button in your JSX (near Download Invoice button):
{order && (
  <ComplaintButton 
    orderId={order._id} 
    orderStatus={order.status} 
  />
)}
```

### 3. Build and Deploy
```bash
npm install
npm run build
# Deploy build folder to your hosting service
```

---

## API Endpoints Reference

### Customer Endpoints
- `GET /api/complaints/check-eligibility/:orderId` - Check if can register
- `POST /api/complaints/register` - Register new complaint
- `GET /api/complaints/:id` - View complaint details
- `POST /api/complaints/:id/messages` - Add message to conversation

### Admin Endpoints
- `GET /api/complaints` - List all complaints (with filters)
- `GET /api/complaints/stats/dashboard` - Get statistics
- `PATCH /api/complaints/:id/status` - Update status
- `POST /api/complaints/:id/reopen` - Reopen closed complaint
- `POST /api/complaints/register-on-behalf` - Staff register for customer

### Webhook Endpoints
- `POST /api/webhooks/complaint/chat` - Register from WhatsApp/chat
- `POST /api/webhooks/complaint/call` - Register from phone call
- `POST /api/webhooks/complaint/email` - Register from email

---

## Testing Checklist

### âœ… Backend Tests
- [ ] Register complaint (customer)
- [ ] Register complaint (staff on behalf)
- [ ] Check time limit validation
- [ ] Check single complaint per order rule
- [ ] Add message to conversation
- [ ] Update complaint status
- [ ] Reopen closed complaint
- [ ] Email notifications sent correctly
- [ ] Webhook endpoints work

### âœ… Frontend Tests
- [ ] Navigate to complaint registration from order details
- [ ] Fill and submit complaint form
- [ ] View complaint details page
- [ ] Send messages in conversation
- [ ] View existing complaint notification
- [ ] Admin dashboard shows all complaints
- [ ] Filter and search complaints

---

## Troubleshooting

### Email Notifications Not Sending
- Check `sendEmail` function is configured in `utils/emailService.js`
- Verify SMTP credentials in environment variables
- Check notification logs in complaint documents

### Complaint Button Not Showing
- Verify order status is DELIVERED or relevant status
- Check authentication token is valid
- Inspect browser console for errors

### Database Errors
- Ensure MongoDB is running
- Verify ComplaintSchema is properly imported
- Check indexes are created

---

## Module Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CLIENT REQUEST                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COMPLAINT ROUTES                        â”‚
â”‚  (/api/complaints, /api/webhooks)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          VALIDATION MIDDLEWARE                       â”‚
â”‚  - Time Limit Check                                 â”‚
â”‚  - Single Complaint Rule                            â”‚
â”‚  - Permissions                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         COMPLAINT CONTROLLER                         â”‚
â”‚  9 Main Endpoints + Webhook Handlers                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DATABASE (MongoDB)                        â”‚
â”‚  ComplaintSchema + User + Order                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       EMAIL NOTIFICATION SERVICE                     â”‚
â”‚  5 Email Templates                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Support & Maintenance

For issues or enhancements:
1. Check `COMPLAINT_SYSTEM_CHANGES.txt` for file locations
2. Review `COMPLAINT_MODULE_STRUCTURE.txt` for architecture
3. All complaint code is marked with ğŸ”§ comments for easy identification

**Module Version**: 1.0.0
**Created**: 2026-02-04
**Status**: Production Ready âœ…
